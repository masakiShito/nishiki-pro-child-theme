name: Deploy Nishiki Pro Child to Lolipop

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-nishiki-pro-child
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      # リポジトリ側の「子テーマのルート」（通常はリポジトリ直下）
      LOCAL_THEME_DIR: "."

      # サーバ側の候補パス（LOLIPOP_REMOTE_PATHがズレてる時の切り分け用）
      # ※実際のデプロイ先はSecretsの LOLIPOP_REMOTE_PATH を使う
      CANDIDATE_PATHS: |
        morofujisan.com/wp-content/themes/nishiki-pro-child
        web/morofujisan.com/wp-content/themes/nishiki-pro-child
        public_html/morofujisan.com/wp-content/themes/nishiki-pro-child
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) 送るものを dist に組み立て（.githubなど不要物は除外）
      - name: Build dist (theme files only)
        run: |
          set -e
          mkdir -p dist
          rsync -av --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude ".DS_Store" \
            --exclude "node_modules" \
            "${LOCAL_THEME_DIR}/" "dist/"
          echo "---- dist tree (top) ----"
          ls -la dist | head -n 50
      # 2) SSHで「起点ディレクトリ」「候補パスの存在」を出力（デバッグ）
      #    これで LOLIPOP_REMOTE_PATH を確定できる
      - name: Debug remote (pwd & candidate paths)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LOLIPOP_HOST }}
          port: ${{ secrets.LOLIPOP_PORT }}
          username: ${{ secrets.LOLIPOP_USER }}
          password: ${{ secrets.LOLIPOP_PASS }}
          script: |
            set -e
            echo "== REMOTE PWD =="
            pwd
            echo "== REMOTE LS (top) =="
            ls -la | head -n 50
            echo "== CHECK CANDIDATE PATHS =="
            for p in $(echo "${{ env.CANDIDATE_PATHS }}" | tr '\n' ' '); do
              echo "--- $p ---"
              if [ -d "$p" ]; then
                echo "[OK] exists"
                ls -la "$p" | head -n 30
              else
                echo "[NG] not found"
              fi
            done
            echo "== TARGET FROM SECRET =="
            echo "${{ secrets.LOLIPOP_REMOTE_PATH }}"
            if [ -d "${{ secrets.LOLIPOP_REMOTE_PATH }}" ]; then
              echo "[OK] secret target exists"
              ls -la "${{ secrets.LOLIPOP_REMOTE_PATH }}" | head -n 30
            else
              echo "[WARN] secret target NOT found (LOLIPOP_REMOTE_PATH may be wrong)"
            fi
      # 3) アップロード（SCPで同期）
      #    strip_components: 1 なので dist/* をターゲット直下に展開
      - name: Upload via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.LOLIPOP_HOST }}
          port: ${{ secrets.LOLIPOP_PORT }}
          username: ${{ secrets.LOLIPOP_USER }}
          password: ${{ secrets.LOLIPOP_PASS }}
          source: "dist"
          target: ${{ secrets.LOLIPOP_REMOTE_PATH }}
          strip_components: 1
          overwrite: true

      # 4) アップ後に「style.css だけ」確認（反映チェック）
      - name: Verify deployment (check style.css)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LOLIPOP_HOST }}
          port: ${{ secrets.LOLIPOP_PORT }}
          username: ${{ secrets.LOLIPOP_USER }}
          password: ${{ secrets.LOLIPOP_PASS }}
          script: |
            set -e
            echo "== VERIFY FILES =="
            ls -la "${{ secrets.LOLIPOP_REMOTE_PATH }}" | head -n 50
            echo "== style.css head =="
            head -n 25 "${{ secrets.LOLIPOP_REMOTE_PATH }}/style.css" || true
            echo "== style.css tail =="
            tail -n 10 "${{ secrets.LOLIPOP_REMOTE_PATH }}/style.css" || true