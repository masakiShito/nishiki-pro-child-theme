name: Deploy Nishiki Pro Child to Lolipop

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

concurrency:
  group: deploy-nishiki-pro-child
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      # 子テーマの実体フォルダ（リポジトリ内）
      LOCAL_THEME_DIR: "themes/nishiki-pro-child"
      DIST_DIR: "dist"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) dist を作る（子テーマの中身だけ）
      - name: Build dist (theme files only)
        run: |
          set -euo pipefail
          rm -rf "${DIST_DIR}"
          mkdir -p "${DIST_DIR}"

          rsync -a --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude ".DS_Store" \
            --exclude "node_modules" \
            "${LOCAL_THEME_DIR}/" "${DIST_DIR}/"

          echo "---- dist tree (top) ----"
          ls -la "${DIST_DIR}" | head -n 100

          # 念のため、テーマとして必須の style.css があるか確認
          test -f "${DIST_DIR}/style.css"

      # 2) SSH で「接続できるか」「デプロイ先が存在するか」を確認（ここで落ちたらSecretsが違う）
      - name: Debug remote (connect & check target dir)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LOLIPOP_HOST }}
          port: ${{ secrets.LOLIPOP_PORT }}
          username: ${{ secrets.LOLIPOP_USER }}
          password: ${{ secrets.LOLIPOP_PASS }}
          script: |
            set -e
            echo "== REMOTE PWD =="
            pwd
            echo "== REMOTE TOP LS =="
            ls -la | head -n 50

            echo "== TARGET DIR (from secret) =="
            echo "${{ secrets.LOLIPOP_REMOTE_PATH }}"

            if [ -d "${{ secrets.LOLIPOP_REMOTE_PATH }}" ]; then
              echo "[OK] target exists"
              ls -la "${{ secrets.LOLIPOP_REMOTE_PATH }}" | head -n 50
            else
              echo "[ERROR] target NOT found"
              exit 1
            fi

      # 3) デプロイ（SFTP）
      - name: Upload via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          username: ${{ secrets.LOLIPOP_USER }}
          server: ${{ secrets.LOLIPOP_HOST }}
          port: ${{ secrets.LOLIPOP_PORT }}
          password: ${{ secrets.LOLIPOP_PASS }}
          local_path: ./dist/*
          remote_path: ${{ secrets.LOLIPOP_REMOTE_PATH }}
          sftp_only: true
          delete_remote_files: false

      # 4) 反映チェック（style.cssを表示）
      - name: Verify deployment (style.css)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LOLIPOP_HOST }}
          port: ${{ secrets.LOLIPOP_PORT }}
          username: ${{ secrets.LOLIPOP_USER }}
          password: ${{ secrets.LOLIPOP_PASS }}
          script: |
            set -e
            echo "== VERIFY TARGET DIR =="
            ls -la "${{ secrets.LOLIPOP_REMOTE_PATH }}" | head -n 80

            echo "== style.css head =="
            head -n 25 "${{ secrets.LOLIPOP_REMOTE_PATH }}/style.css" || true

            echo "== style.css tail =="
            tail -n 10 "${{ secrets.LOLIPOP_REMOTE_PATH }}/style.css" || true

            # 二重配置事故が起きてないか念のためチェック
            if [ -d "${{ secrets.LOLIPOP_REMOTE_PATH }}/themes/nishiki-pro-child" ]; then
              echo "[WARN] nested themes/nishiki-pro-child exists (previous bad deploy). Consider deleting it."
              ls -la "${{ secrets.LOLIPOP_REMOTE_PATH }}/themes" | head -n 50
            fi